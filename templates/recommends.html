{% extends 'base.html' %}

{% block style %}
<style>
    a:hover {
        text-decoration: none;
    }

    .recommend-cluster {
        cursor: pointer;
    }

    .recommend-cluster:hover {
        background-color: #eee !important;
    }
</style>
{% endblock %}

{% block main %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src=" https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js " defer></script>


<div class="container" style="min-height: 90vh !important;">
    <div class="row">
        <div class="col-12">
            <h1 class="section-header">Các gợi ý mua chung</h1>

            <div id="main-content">

            </div>

            <script>
                (async function () {
                    let response = await axios.get("/api/nguoi-dung/goi-y-mua-chung");
                    let recommendData = response.data.recommend_data;

                    const get_uuid = (function () {
                        let uniKeyCount = 0;
                        return () => `uuid-${++uniKeyCount}`;
                    })();

                    let presentHTML = "";
                    console.log({ recommendData });
                    let uniKeyCount = 0;
                    for (const tp_ma in recommendData) {
                        const tp_ten = recommendData[tp_ma][0]["nodes"][0]["detail"]["TP_TEN"]
                        presentHTML += `<h4>${tp_ten} (mã thực phẩm: ${tp_ma})</h4>`;
                        // show cluster one by one
                        for (const cluster of recommendData[tp_ma]) {
                            const nodes = cluster["nodes"];
                            let uuid = get_uuid()

                            presentHTML += `<div class='bg-light p-3 rounded border shadow-sm d-flex flex-wrap justify-content-start align-items-center recommend-cluster' data-toggle='modal' data-target='#${uuid}'>`;

                            const max_of_CTDKM_SO_LUONG = Math.max(...nodes.map(node => node.detail.CTDKM_SO_LUONG))
                            const host_ND_MA = nodes.find(node => node.detail.CTDKM_SO_LUONG == max_of_CTDKM_SO_LUONG).detail.ND_MA;

                            presentHTML += nodes.map(node => {
                                let isHost = false;
                                let loginUser = false;
                                let tagClasses = [];
                                if (node.approve)
                                    tagClasses = [...tagClasses, ...['bg-success', 'text-light']];
                                else
                                    tagClasses = [...tagClasses, ...['bg-secondary', 'text-light']];

                                if (Cookies.get("ND_MA") == node.detail.ND_MA) {
                                    tagClasses = [...tagClasses, ...['font-weight-bold']];
                                    loginUser = true
                                }

                                if (node.detail.ND_MA == host_ND_MA)
                                    isHost = true;

                                return `
                                    <span class="p-2 m-2 text-center border rounded ${tagClasses.join(' ')}" style="flex-basis: 33%">${loginUser ? "Bạn" : node.detail.ND_TAI_KHOAN} (mua ${node.detail.CTDKM_SO_LUONG})
                                    ${isHost ? `<span class="badge badge-danger">host</span>` : ''}
                                    </span>
                                `
                            }).join('')


                            presentHTML += "</div>";

                            // add modal head
                            presentHTML += `
                            <div class="modal fade" id="${uuid}" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="exampleModalCenterTitle">Xác nhận mua chung</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>`

                            // add modal body
                            presentHTML += `<div class="modal-body">`;
                            presentHTML += `<div>Bạn đồng ý mua chung với ${nodes.map(node => '<b>' + node.detail.ND_TAI_KHOAN + '</b>').join(', ')}?</div>`;

                            presentHTML += `</div>`;

                            // add model foot, that include hidden form
                            presentHTML += `
                                        <div class="modal-footer">
                                            <form name="frm-${get_uuid()}" action="/nguoi-dung/approve-join-cluster" method="post">
                                                <input type="hidden" name="tp_ma" value="${tp_ma}">
                                                <input type="hidden" name="cluster_index" value="${cluster.cluster_index}">
                                                
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                                <button type="submit" class="btn btn-primary js-btn-approve">Đồng ý</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>`;

                            presentHTML += "<br />"
                        }

                    }

                    $("#main-content").html(presentHTML);
                })();
            </script>


        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    $(function () {
        $("#js-btn-approve").click(async function (e) {
            let tp_ma = $(this).attr("data-tp_ma");
            let dmtp_ma = $(this).attr("data-cluster_index");
            $(this).siblings("form[name^='frm']").submit();
        });
    });
</script>
{% endblock %}